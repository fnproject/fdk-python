FROM container-registry.oracle.com/os/oraclelinux:8-slim

RUN microdnf install -y python38 &&\
    microdnf install -y python38-pip &&\
    microdnf clean all

ARG RPM_VERSION=latest
ENV RPM_VERSION=${RPM_VERSION:-v1.0.0}

RUN microdnf -y install gzip \
    zip \
    tar \
    rpm \
    rpm-build \
    binutils \
    freetype fontconfig

RUN microdnf clean all

RUN mkdir -p /root/rpmbuild/SOURCES

RUN mkdir /fdk-python
WORKDIR /fdk-python

COPY ./requirements.txt /fdk-python 
COPY ./internal/build-scripts/rpm/fdk-python38.spec  /fdk-python
COPY ./internal/build-scripts/rpm/copy_rpm.sh /fdk-python 

RUN mkdir ./fdk_dependencies
RUN pip3 download -d ./fdk_dependencies --no-cache --no-cache-dir -r requirements.txt
COPY ./dist/*whl ./fdk/

COPY ./LICENSE ./fdk/
COPY ./THIRD_PARTY_LICENSES.txt ./fdk/

RUN tar cvf fdk-$RPM_VERSION.tar.gz ./fdk

RUN cp  fdk-$RPM_VERSION.tar.gz ~/rpmbuild/SOURCES
RUN cp -r ./fdk_dependencies/* ~/rpmbuild/SOURCES 

RUN rpmbuild --define "_rpm_version ${RPM_VERSION}"  -ba fdk-python38.spec 